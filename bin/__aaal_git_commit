#!/usr/bin/env bash
set -e

added_files="$(git ls-files -o --exclude-standard --full-name -- `git rev-parse --show-toplevel`)"
if [[ ! -z "${added_files}" ]]; then
    echo "Untracked files exists:"
    echo "${added_files}"
    echo ""

    if ! __aaal_prompt_yn "Untracked files will not be added. Continue commit anyway?" N ; then
        exit
    fi
fi

if [[ -f "$(git rev-parse --show-toplevel)/.git/MERGE_HEAD" ]]; then
    git commit --no-edit
    exit
fi

if [[ ! $(git status --porcelain) ]]; then
    # No changes, done!
    >&2 echo "No changes to commit!"
    exit
fi

ticket=""
branch_name="$(git "rev-parse" "--abbrev-ref" "HEAD")"
if [[ "${branch_name}" == "" ]]; then
    >&2 echo "no branch found"
    exit 1 # False
fi
if [[ "${branch_name}" =~ ^.*/([a-zA-Z]+-[0-9]+).*$ ]]; then
    ticket="${BASH_REMATCH[1]}"
fi

description="$(__aaal_git_describe "${@}")" # Will exit if failed

git commit -m "${description}" -m "${ticket}"

CP='\033[95m' # pink
CD='\033[39m' # default
echo -e $"${CP}MESSAGE:${CD}"
echo "${description}"
if [[ -n "${ticket}" ]]; then
    echo ""
    echo "${ticket}"
fi
